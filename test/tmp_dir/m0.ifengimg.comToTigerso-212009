(function(win,doc){"use strict";var LOGIN_URL="http://id.ifeng.com/allsite/login";var UPDATE_NICK_NAME_URL="http://id.ifeng.com/allsite/oauthlogin";var CLOSE_IMAGE_SRC="http://y0.ifengimg.com/p/login/20130924/close_01.png";var LOGIN_SID_INTERVAL=null;var LOGIN_TK_INTERVAL=null;var NICK_NAME_INTERVAL=null;var LOGIN_SUCCESS_CALLBACK=[];var LOGIN_CLOSE_CALLBACK=[];var LOGIN_OUT_CALLBACK=[];var NICK_NAME_CALLBACK=[];var LOGIN_PARAMS=[];var login_init=function(){if(login_cookie.get("sid")){if(LOGIN_SUCCESS_CALLBACK.length>0){for(var e=0,n=LOGIN_SUCCESS_CALLBACK.length;e<n;e++){LOGIN_SUCCESS_CALLBACK[e]({sid:login_cookie.get("sid"),uname:_processSidtoUname()})}}}else{login_show()}};var _login_listening=function(){clearInterval(LOGIN_TK_INTERVAL);clearInterval(LOGIN_SID_INTERVAL);clearInterval(NICK_NAME_INTERVAL);LOGIN_TK_INTERVAL=setInterval(_processTK,100);LOGIN_SID_INTERVAL=setInterval(_processSID,100);NICK_NAME_INTERVAL=setInterval(_processNickName,100)};var _login_nick_name_listening=function(){clearInterval(NICK_NAME_INTERVAL);NICK_NAME_INTERVAL=setInterval(_processNickName,100)};var _processNickName=function(){var NTK="";if(""!==login_cookie.get("IF_NTK")){NTK=eval("("+decodeURIComponent(login_cookie.get("IF_NTK"))+")");if(1===NTK.code/1){clearInterval(NICK_NAME_INTERVAL);doc.getElementById("login_index").parentNode.removeChild(doc.getElementById("login_index"));doc.getElementById("masker").parentNode.removeChild(doc.getElementById("masker"));login_cookie.del("IF_NTK",".ifeng.com");if(NICK_NAME_CALLBACK.length>0){for(var i=0,l=NICK_NAME_CALLBACK.length;i<l;i++){NICK_NAME_CALLBACK[i]()}}}}};var _processSID=function(){var e={};if(login_cookie.get("sid")){clearInterval(LOGIN_SID_INTERVAL);clearInterval(LOGIN_TK_INTERVAL);e.sid=login_cookie.get("sid");e.uname=_processSidtoUname();doc.getElementById("login_index").parentNode.removeChild(doc.getElementById("login_index"));doc.getElementById("masker").parentNode.removeChild(doc.getElementById("masker"));if(LOGIN_SUCCESS_CALLBACK.length>0){for(var n=0,i=LOGIN_SUCCESS_CALLBACK.length;n<i;n++){LOGIN_SUCCESS_CALLBACK[n](e)}}}};var _processTK=function(){var OTK="";if(""!==login_cookie.get("IF_OTK")){clearInterval(LOGIN_TK_INTERVAL);OTK=eval("("+decodeURIComponent(login_cookie.get("IF_OTK"))+")");if(1===OTK.code){login_cookie.del("IF_OTK",".ifeng.com");doc.getElementById("login_iframe_out").innerHTML='<iframe id="login_iframe" width="520" height="320" scrolling="no" frameborder="no" border="0" style="border:0px; margin:0px;padding:0px;" src="'+OTK.data.url+'"></iframe>'}else{login_cookie.del("IF_OTK",".ifeng.com");doc.getElementById("login_iframe_out").innerHTML='<iframe id="login_iframe" width="520" height="410" scrolling="no" frameborder="no" border="0" style="border:0px; margin:0px;padding:0px;" src="'+LOGIN_URL+_processPARAM()+'"></iframe>';alert(OTK.message)}_login_listening()}};var login_show=function(e){var n=doc.body,i=doc.getElementById("login_index"),o=null,t=null;var r=_getDom(n.lastChild);if("undefined"!==typeof r){if("undefined"===typeof i||null===i){o=doc.createElement("div");o.id="masker";o.style.cssText="background:#000; position:fixed; left:0; top:0; bottom:0px; width:100%; height:100%; opacity:.80; filter:alpha(opacity=80); z-index:9999; overflow:hidden; zoom: 1; display: block;";r.parentNode.insertBefore(e?_login_html(true):_login_html(),r);doc.getElementById("login_index").parentNode.insertBefore(o,doc.getElementById("login_index"));doc.getElementById("login_iframe_contain").style.cssText="position:fixed; _position:absolute; top:50%; left:50%; margin-left:-260px; margin-top: -207px; z-index:99999;"}else{if(doc.getElementById("login_iframe_out")){doc.getElementById("login_iframe_out").innerHTML='<iframe id="login_iframe" width="520" height="410" scrolling="no" frameborder="no" border="0" style="border:0px; margin:0px;padding:0px;" src="'+LOGIN_URL+_processPARAM()+'"></iframe>'}o=doc.getElementById("masker");o["style"]["display"]="block";i["style"]["display"]="block"}t=doc.getElementById("login_iframe_close_btn");_bindEvent.add(t,"click",_loginHide);if(e){_login_nick_name_listening()}else{_login_listening()}}};var _loginHide=function(){clearInterval(LOGIN_TK_INTERVAL);clearInterval(LOGIN_SID_INTERVAL);clearInterval(NICK_NAME_INTERVAL);doc.getElementById("login_index").parentNode.removeChild(doc.getElementById("login_index"));doc.getElementById("masker").parentNode.removeChild(doc.getElementById("masker"));if(LOGIN_CLOSE_CALLBACK.length>0){for(var e=0,n=LOGIN_CLOSE_CALLBACK.length;e<n;e++){LOGIN_CLOSE_CALLBACK[e]()}}};var _processPARAM=function(){var e="",n=0,i=0;if(LOGIN_PARAMS.length>0){e="?",i=LOGIN_PARAMS.length;for(;n<i;n++){for(var o in LOGIN_PARAMS[n]){e+=(0!==n?"&":"")+o+"="+encodeURIComponent(LOGIN_PARAMS[n][o])}}}return e};var login_out=function(){var e=function(e){var n=0,i="",o=[],t=null,r=null,l=null;if(1===e.code){for(;n<e.data.turl.length;n++){i='<iframe style="display: none;" id="logout_'+n+'_iframe" src="'+e.data.turl[n]+'"></iframe>';o.push(i)}t=document.createElement("div");t.id="iframesDIV";t.innerHTML=o.join("");r=_getDom(document.body.lastChild);r.parentNode.insertBefore(t,r);l=setInterval(function(){if(""===login_cookie.get("sid")){clearInterval(l);if(LOGIN_OUT_CALLBACK.length>0){for(var e=0,n=LOGIN_OUT_CALLBACK.length;e<n;e++){LOGIN_OUT_CALLBACK[e]()}}}},100)}};var n={url:"http://id.ifeng.com/index.php/api/logout",success:e};ajax.jsonp(n)};var _getDom=function(e){if(e.nodeType===1){return e}if(e.previousSibling){return _getDom(e.previousSibling)}return null};var _bindEvent={add:function(e,n,i){if(e.attachEvent){e["e"+n+i]=i;e[n+i]=function(){e["e"+n+i](window.event)};e.attachEvent("on"+n,e[n+i])}else{e.addEventListener(n,i,false)}},remove:function(e,n,i){if(e.detachEvent){e.detachEvent("on"+n,e[n+i]);e[n+i]=null}else{e.removeEventListener(n,i,false)}}};var _login_html=function(e){var n=doc.createElement("div"),i="";n.id="login_index";n.style.cssText="width:1000px; margin:0 auto; display: block;";if(e){i=UPDATE_NICK_NAME_URL+(_processPARAM()?"&nick":"?nick")}else{i=LOGIN_URL+_processPARAM()}n.innerHTML='<div id="login_iframe_contain">'+'<i id="login_iframe_close_btn" style="cursor:pointer; position:absolute; right:-10px; top:-10px;">'+'<a href="javascript:;" style="cursor:pointer;width:26px;height:26px;overflow:hidden;background:url('+CLOSE_IMAGE_SRC+") no-repeat;display:block;text-indent:-9999px;_background:none;_filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(enabled=true, sizingMethod=scale, src='"+CLOSE_IMAGE_SRC+"');\">关闭</a>"+"</i>"+'<div id="login_iframe_out">'+'<iframe id="login_iframe" width="520" height="410" scrolling="no" frameborder="no" border="0" style="border:0px; margin:0px;padding:0px;" src="'+i+'"></iframe>'+"</div>"+"</div>";return n};var login_cookie={get:function(e){var n=login_cookie,i=document.cookie,o=n._removeBlanks(i),t=o.split(";");for(var r=0;r<t.length;r++){var l=t[r].split("=");if(l.length>1&&l[0]===e){return l[1]}}return""},del:function(e,n){document.cookie=e+"=; path=/; domain="+n+"; expires=Thu, 01-Jan-70 00:00:01 GMT"},_removeBlanks:function(e){var n="";for(var i=0;i<e.length;i++){var o=e.charAt(i);if(o!==" "){n+=o}}return n}};var ajax={jsonp:function(e){var n=e.url;var i=e.success;var o=[];var t=e.scope||window;var r;if(typeof e.data==="object"){for(var l in e.data){o.push(l+"="+encodeURIComponent(e.data[l]))}}if(typeof e.callback==="string"&&e.callback!==""){r=e.callback}else{r="f"+(new Date).valueOf().toString(16)}o.push("callback="+r);o.push("_="+(new Date).valueOf());if(n.indexOf("?")<0){n=n+"?"+o.join("&")}else{n=n+"&"+o.join("&")}var a=document.createElement("script");a.src=n;window[r]=function(){i.apply(t,[].slice.apply(arguments).concat("success",e))};var _=document.getElementsByTagName("script")[0];_.parentNode.insertBefore(a,_)}};var _processSidtoUname=function(){return login_cookie.get("sid")?decodeURIComponent(login_cookie.get("sid").substring(32)):decodeURIComponent(login_cookie.get("IF_USER"))};var isLogin=function(){return login_cookie.get("sid")?true:false};var _regLoginCallback=function(e,n){if("undefined"===typeof e||"undefined"===typeof n){return false}switch(e){case 1:if("function"===typeof n){LOGIN_SUCCESS_CALLBACK.push(n);break}case 2:if("function"===typeof n){LOGIN_CLOSE_CALLBACK.push(n);break}case 3:if("function"===typeof n){LOGIN_OUT_CALLBACK.push(n);break}}};var _regLoginParam=function(e,n){var i={};if("undefined"!==e&&"undefined"!==n){i[e]=n;LOGIN_PARAMS.push(i)}};var _nickNameCallback=function(e){if("function"===typeof e){NICK_NAME_CALLBACK.push(e)}};win.IS_LOGIN=isLogin;win.GLOBAL_LOGIN=login_init;win.GLOBAL_LOGIN_OUT=login_out;win.REG_LOGIN_CALLBACK=_regLoginCallback;win.REG_LOGIN_PARAMS=_regLoginParam;win.NICK_NAME=login_show;win.NICK_NAME_CALLBACK=_nickNameCallback})(window,document);